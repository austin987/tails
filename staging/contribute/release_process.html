<!DOCTYPE html>

<html lang="en" dir="ltr" xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Tails - Release process</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="icon" href="../favicon.ico" type="image/x-icon" />

<link rel="stylesheet" href="../style.css" type="text/css" />

<link rel="stylesheet" href="../local.css" type="text/css" />


<script src="../lib/js/mirror-dispatcher.js" type="text/javascript"></script>









</head>


<body class="en">


<div class="searchform">



</div>

<div class="banner" role="banner">
  <a class="tails" href="../index.en.html">
    <span class="acronym">Tails</span><br/>
    <span class="slogan">The Amnesic Incognito Live System</span>
  </a>
</div>

<div class="page">

<div class="pageheader">
<div class="header">
<span>
<span class="parentlinks">
<ul id="crumbs">
<li><a href="../index.en.html"><img src="../lib/home.png"></a></li>







<li><a href="../contribute.en.html">contribute</a></li>




<li>Release process</li>

</ul>
</span>
<span class="title">
Release process
</span>
</span>
</div>










</div>



<div class="sidebar" role="navigation">
<div class="download button">
  <a href="../install.en.html"><span class="download">Install</span>
    <span class="tails">Tails 
3.9
</span>
    <span class="date">
2018-09-05</span></a>
</div>




<div class="links">
  <ul>
    <li><a href="../about.en.html">About</a></li>
    <li><a href="../getting_started.en.html">Getting started…</a></li>
    <li><a href="../doc.en.html">Documentation</a></li>
    <li><a href="../support.en.html">Help &amp; Support</a></li>
    <li><a href="../contribute.en.html">Contribute</a></li>
    <li><a href="../news.en.html">News</a></li>
  </ul>
</div>




<div class="donate button">
    <a href="https://tails.boum.org/donate?r=sidebar">Donate</a>
</div>


</div>



<div id="pagebody">

<div id="content" role="main">


<div class="toc">
<ol>
	<li class="L1"><a href="#index1h1">Requirements</a>
	</li>
	<li class="L1"><a href="#index2h1">Environment</a>
	</li>
	<li class="L1"><a href="#index3h1">Pre-freeze</a>
	<ol>
		<li class="L2"><a href="#index1h2">Coordinate with Debian security updates</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index4h1">Sanity check</a>
	</li>
	<li class="L1"><a href="#index5h1">Freeze</a>
	<ol>
		<li class="L2"><a href="#index2h2">Major release</a>
		</li>
		<li class="L2"><a href="#index3h2">Point-release</a>
		</li>
		<li class="L2"><a href="#index4h2">Common steps for point and major releases</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index6h1">Update included files</a>
	<ol>
		<li class="L2"><a href="#index5h2">Upgrade bundled binary Debian packages</a>
		</li>
		<li class="L2"><a href="#index6h2">Upgrade Tor Browser</a>
		</li>
		<li class="L2"><a href="#index7h2">Upgrade Tor Browser AppArmor profile</a>
		</li>
		<li class="L2"><a href="#index8h2">Upgrade Thunderbird</a>
		</li>
		<li class="L2"><a href="#index9h2">Update PO files</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index7h1">When preparing an actual release</a>
	<ol>
		<li class="L2"><a href="#index10h2">Major release</a>
		</li>
		<li class="L2"><a href="#index11h2">Point-release</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index8h1">Update other base branches</a>
	</li>
	<li class="L1"><a href="#index9h1">Update more included files</a>
	<ol>
		<li class="L2"><a href="#index12h2">Changelog</a>
		</li>
		<li class="L2"><a href="#index13h2">Included website</a>
		</li>
		<li class="L2"><a href="#index14h2">Website translations</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index10h1">Call for translation</a>
	</li>
	<li class="L1"><a href="#index11h1">Enable OpenPGP signing</a>
	</li>
	<li class="L1"><a href="#index12h1">Build the almost-final image</a>
	</li>
	<li class="L1"><a href="#index13h1">Tag the release in Git</a>
	</li>
	<li class="L1"><a href="#index14h1">Prepare the versioned APT suites</a>
	</li>
	<li class="L1"><a href="#index15h1">Build images</a>
	<ol>
		<li class="L2"><a href="#index15h2">Sanity check</a>
		</li>
		<li class="L2"><a href="#index16h2">SquashFS file order</a>
		</li>
		<li class="L2"><a href="#index17h2">Build the final image</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index16h1">Generate the OpenPGP signatures and Torrents</a>
	</li>
	<li class="L1"><a href="#index17h1">Prepare incremental upgrades</a>
	<ol>
		<li class="L2"><a href="#index18h2">Build the Incremental Upgrade Kits</a>
		</li>
		<li class="L2"><a href="#index19h2">Prepare upgrade-description files</a>
		</li>
		<li class="L2"><a href="#index20h2">Prepare the ISO description file for Tails Verification</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index18h1">Done with OpenPGP signing</a>
	</li>
	<li class="L1"><a href="#index19h1">Upload images</a>
	<ol>
		<li class="L2"><a href="#index21h2">Sanity check</a>
		</li>
		<li class="L2"><a href="#index22h2">Publish the ISO and IUKs over HTTP</a>
		</li>
		<li class="L2"><a href="#index23h2">Announce, seed and test the Torrent</a>
		</li>
		<li class="L2"><a href="#index24h2">ISO history</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index20h1">Testing</a>
	</li>
	<li class="L1"><a href="#index21h1">Update the website and Git repository</a>
	<ol>
		<li class="L2"><a href="#index25h2">If preparing a final release</a>
		</li>
		<li class="L2"><a href="#index26h2">If preparing a release candidate</a>
		</li>
		<li class="L2"><a href="#index27h2">In any case</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index22h1">Go wild!</a>
	<ol>
		<li class="L2"><a href="#index28h2">Wait for the HTTP mirrors to catch up</a>
		</li>
		<li class="L2"><a href="#index29h2">Sanity checks</a>
		</li>
		<li class="L2"><a href="#index30h2">Push</a>
		</li>
		<li class="L2"><a href="#index31h2">Check translation are correct</a>
		</li>
		<li class="L2"><a href="#index32h2">Bug tracker</a>
		</li>
		<li class="L2"><a href="#index33h2">Twitter</a>
		</li>
		<li class="L2"><a href="#index34h2">Tor blog</a>
		</li>
		<li class="L2"><a href="#index35h2">Amnesia news</a>
		</li>
	</ol>
	</li>
	<li class="L1"><a href="#index23h1">Prepare for the next development cycle</a>
	</li>
	<li class="L1"><a href="#index24h1">Related pages</a>
	</li>
</ol>
</div>


<p>See the <a href="./release_schedule.html">release schedule</a>.</p>

<div class="caution">
Read the remainder of this document from the branch used to prepare the release!
</div>


<h1><a name="index1h1"></a>Requirements</h1>

<p>To release Tails you'll need some packages installed:</p>

<ul>
<li><code>tidy mktorrent transmission-cli</code></li>
<li>aufs DKMS module for your running kernel.</li>
<li><a href="https://tracker.debian.org/pkg/squashfs%2Dtools">squashfs-tools</a> that honors <code>$SOURCE_DATE_EPOCH</code>.
Install it from our custom <code>devel</code> APT suite.</li>
<li><code>tails-iuk</code> dependencies, including suggested packages (see
<code>debian/control</code> in the <code>debian</code> branch of its repo)</li>
<li><code>tails-perl5lib</code> dependencies (same trick as <code>tails-iuk</code> to get the
list)</li>
<li><code>po4a</code> <em>from Stretch</em>: the version in testing/sid extracts Markdown headings
 in a different way, which makes tons of strings fuzzy.</li>
</ul>


<h1><a name="index2h1"></a>Environment</h1>

<p>Export the following environment variables to be able to copy'n'paste
the scripts snippets found on this page:</p>

<ul>
<li><p>version numbers (see <a href="./release_schedule.html#versioning">release schedule</a>):</p>

<pre><code>  export VERSION=$(dpkg-parsechangelog -SVersion)
  export TAG=$(echo "${VERSION:?}" | sed -e 's,~,-,')
  export PREVIOUS_VERSION=$(dpkg-parsechangelog --offset 1 --count 1 -SVersion)
  export PREVIOUS_TAG=$(echo "${PREVIOUS_VERSION:?}" | sed -e 's,~,-,')
</code></pre></li>
<li><p><code>NEXT_PLANNED_VERSION</code>: set to the version number of the next Tails release
(e.g. 0.23 when releasing 0.22.1, and 1.3 when releasing 1.2)</p></li>
<li><code>NEXT_PLANNED_MAJOR_VERSION</code>: set to the version number of the next
<em>major</em> Tails release; if you're preparing a RC for a major release,
use that major release; otherwise, use whatever the next planned
major release is</li>
<li><code>SECOND_NEXT_PLANNED_MAJOR_VERSION</code>: set to the version number of
the second next <em>major</em> Tails release; e.g. if preparing the RC for
the 3.9 major release, then set this to 3.12 (3.9 is the next major
release, 3.10 and 3.11 are bugfix releases, 3.12 is a major
release).</li>
<li><code>NEXT_PLANNED_MINOR_VERSION</code>: set to the version number of the next
<em>minor</em> Tails release; if the next release is a point-release, use
that one; otherwise, use <code>${VERSION}.1</code></li>
<li><code>MAJOR_RELEASE</code>: set to 1 if preparing a major release or a release
candidate for a major release, to 0 otherwise</li>
<li><code>ISOS</code>: the directory where one stores <code>tails-amd64-*</code>
sub-directories like the ones downloaded with BitTorrent.</li>
<li><code>ARTIFACTS</code>: the directory where build artifacts (e.g.
the <code>.packages</code> file) land.</li>
<li><code>MASTER_CHECKOUT</code>: a checkout of the <code>master</code> branch of the main
Tails Git repository.</li>
<li><code>RELEASE_BRANCH=$(if [ "$MAJOR_RELEASE" = 1 ]; then echo -n testing; else echo -n stable; fi)</code></li>
<li><code>RELEASE_CHECKOUT</code>: a checkout of the branch of the main Tails Git
repository used to prepare the release (<code>stable</code> or <code>testing</code>).</li>
<li><code>TAILS_SIGNATURE_KEY=A490D0F4D311A4153E2BB7CADBB802B258ACD84F</code></li>
<li><code>IUK_CHECKOUT</code>: a checkout of the relevant tag of the <code>iuk</code>
Git repository.</li>
<li><code>PERL5LIB_CHECKOUT</code>: a checkout of the relevant tag of the
<code>perl5lib</code> Git repository.</li>
<li><code>DIST</code>: either 'alpha' (for RC:s) or 'stable' (for actual releases)</li>
<li><code>export WEBSITE_RELEASE_BRANCH="web/release-${TAG:?}"</code></li>
</ul>


<h1><a name="index3h1"></a>Pre-freeze</h1>

<p>The <a href="./working_together/roles/release_manager.html">release manager</a> role
documentation has more tasks that should be done early enough.</p>

<h2><a name="index1h2"></a>Coordinate with Debian security updates</h2>

<p>See <a href="./release_process/Debian_security_updates.html">Debian security updates</a>.</p>

<h1><a name="index4h1"></a>Sanity check</h1>

<p>Visit the <a href="https://jenkins.tails.boum.org/view/RM/">Jenkins RM view</a>
and check that the jobs for the release branch have good enough results.</p>

<h1><a name="index5h1"></a>Freeze</h1>

<h2><a name="index2h2"></a>Major release</h2>

<p>If we are at freeze time for a major release:</p>

<ol>
<li><p>Merge the <code>master</code> Git branch into <code>devel</code>:</p>

<pre><code> git checkout devel &amp;&amp; git fetch origin &amp;&amp; git merge --no-ff origin/master
</code></pre></li>
<li><p><a href="./APT_repository/custom.html#workflow-merge-overlays">Merge each APT overlay suite</a>
listed in the <code>devel</code> branch's <code>config/APT_overlays.d/</code> into the <code>devel</code>
APT suite.</p></li>
<li><p>Merge the <code>devel</code> Git branch into the <code>testing</code> one:</p>

<pre><code> git checkout testing &amp;&amp; git merge devel
</code></pre>

<p>... and check that the resulting <code>config/APT_overlays.d/</code> in the
<code>testing</code> branch is empty.</p></li>
<li><p><a href="./APT_repository/custom.html#workflow-reset">Hard reset</a> the <code>testing</code>
custom APT suite to the current state of the <code>devel</code> one.</p></li>
<li><p><a href="./APT_repository/time-based_snapshots.html#freeze">Freeze</a> the
time-based APT repository snapshots that shall be used
during the freeze.</p></li>
<li><p>Make it so the time-based APT repository snapshots are kept around
long enough, by bumping their <code>Valid-Until</code> to 10 days after the
next major release (the one <em>after</em> the one you're preparing)'s
scheduled date:
<a href="./APT_repository/time-based_snapshots.html#bump-expiration-date-for-all-snapshots">time-based snapshots</a></p></li>
</ol>


<h2><a name="index3h2"></a>Point-release</h2>

<p>If we are at freeze time for a point-release:</p>

<ol>
<li><p>Merge the <code>master</code> Git branch into <code>stable</code>:</p>

<pre><code> git checkout stable &amp;&amp; git fetch &amp;&amp; git merge --no-ff origin/master
</code></pre></li>
<li><p><a href="./APT_repository/custom.html#workflow-merge-overlays">Merge each APT overlay suite</a>
listed in the <code>stable</code> branch's <code>config/APT_overlays.d/</code> into the <code>stable</code>
APT suite.</p></li>
</ol>


<h2><a name="index4h2"></a>Common steps for point and major releases</h2>

<p>Reset the release branch's <code>config/base_branch</code>:</p>

<pre><code>    echo "${RELEASE_BRANCH:?}" &gt; config/base_branch &amp;&amp; \
       git commit config/base_branch \
           -m "Restore ${RELEASE_BRANCH:?}'s base branch."
</code></pre>

<p>Bootstrap manual testing coordination:</p>

<ol>
<li>Create a pad.</li>
<li>Copy the <a href="./release_process/test.html">manual test suite</a>
into it.</li>
<li>Send the pad URL to the usual testers (see <code>manual_testers.mdwn</code> in
the <code>internal.git</code> repository).
XXX: move this document to a repo that all RMs have access to.</li>
</ol>


<h1><a name="index6h1"></a>Update included files</h1>

<p><a id="upgrade-custom-debs"></a></p>

<h2><a name="index5h2"></a>Upgrade bundled binary Debian packages</h2>

<p>Skip this section if you are preparing a point-release.</p>

<p>The goal here is to make sure the bundled binary Debian packages contain
up-to-date localization files, so:</p>

<ul>
<li>If you are preparing a release candidate, build at least the packages
that change user-visible strings, so that translators can use the RC
to check the status of their work and identify what's left to do.</li>
<li>If you are preparing a major release, build at least the packages
that got translation updates since the RC: we've sent a call for
translation while releasing the RC so the least we can do is to
incorporate the work that ensued into our final release :)</li>
</ul>


<p>For each bundled Debian package, <code>cd</code> into the package's root
directory (e.g. a checkout of the <code>whisperback</code> repository),
import translations from Transifex and sanity-check them:</p>

<pre><code>cd whisperback
"${RELEASE_CHECKOUT:?}"/import-translations &amp;&amp; \
"${RELEASE_CHECKOUT:?}"/submodules/jenkins-tools/slaves/check_po
</code></pre>

<p>Then, <code>git rm</code> the PO files that have issues (alternatively, if you
feel like it you can fix them but your changes will be overwritten
next time we import translations from Transifex).</p>

<p>And finally, commit:</p>

<pre><code>git add po &amp;&amp; git commit \
    -m "Update POT and PO files, pull updated translations from Transifex."
</code></pre>

<p>Then see the relevant release processes, and upload the packages to
the release branch's custom APT suite:</p>

<ul>
<li><a href="./release_process/tails-installer.html">tails-installer</a></li>
<li><a href="./release_process/tails-greeter.html">tails-greeter</a></li>
<li><a href="./release_process/perl5lib.html">perl5lib</a></li>
<li><a href="./release_process/persistence-setup.html">persistence-setup</a></li>
<li><a href="./release_process/tails-iuk.html">tails-iuk</a></li>
<li>whisperback:

<ul>
<li>follow <a href="https://git-tails.immerda.ch/whisperback/plain/HACKING">upstream release process</a></li>
<li>build a Debian package</li>
</ul>
</li>
</ul>


<h2><a name="index6h2"></a>Upgrade Tor Browser</h2>

<p>See the dedicated page: <a href="./release_process/tor-browser.html">tor-browser</a></p>

<h2><a name="index7h2"></a>Upgrade Tor Browser AppArmor profile</h2>

<p>See the dedicated page: <span class="createlink">browser-apparmor-patch</span></p>

<h2><a name="index8h2"></a>Upgrade Thunderbird</h2>

<p>See the dedicated page: <a href="./release_process/thunderbird.html">thunderbird</a></p>

<h2><a name="index9h2"></a>Update PO files</h2>

<p>Pull updated translations for languages translated in Transifex,
refresh the code PO files,
and commit the result, including new PO files:</p>

<pre><code>cd "${RELEASE_CHECKOUT:?}" &amp;&amp; \
./import-translations  &amp;&amp; \
./refresh-translations &amp;&amp; \
./submodules/jenkins-tools/slaves/check_po &amp;&amp; \
git add po &amp;&amp; git commit -m 'Update PO files.'
</code></pre>

<p>If <code>check_po</code> complains:</p>

<ul>
<li>delete the offending PO files;</li>
<li>send a note to <a href="mailto:tails-l10n@boum.org">&#116;&#97;&#105;&#108;&#115;&#45;&#108;&#49;&#48;&#110;&#64;&#98;&#111;&#117;&#109;&#46;&#111;&#114;&#103;</a> so that they get in touch with
whoever can fix them.</li>
</ul>


<h1><a name="index7h1"></a>When preparing an actual release</h1>

<p>If we're about to prepare an image for a final (non-RC) release, then
follow these instructions:</p>

<h2><a name="index10h2"></a>Major release</h2>

<p><a href="./APT_repository/custom.html#workflow-merge-overlays">Merge each APT overlay suite</a>
listed in the <code>testing</code> branch's <code>config/APT_overlays.d/</code> into the <code>testing</code>
custom APT suite.</p>

<h2><a name="index11h2"></a>Point-release</h2>

<div class="note">
For point-releases, we generally do not put any RC out, so freeze time
is the same as preparing the actual release. Hence, the following
steps have already been done above, and this section is a noop in the
general case.
</div>


<p><a href="./APT_repository/custom.html#workflow-merge-overlays">Merge each APT overlay suite</a>
listed in the <code>stable</code> branch's <code>config/APT_overlays.d/</code> into the <code>stable</code>
custom APT suite.</p>

<h1><a name="index8h1"></a>Update other base branches</h1>

<ol>
<li><p>Merge the release branch into <code>devel</code> following the instructions for
<a href="./APT_repository/custom.html#workflow-merge-main-branch">merging base branches</a>.</p></li>
<li><p><a href="./APT_repository/time-based_snapshots.html#thaw">Thaw</a>, on the devel
branch, the time-based APT repository snapshots that were used
during the freeze.</p></li>
<li><p>Merge <code>devel</code> into <code>feature/buster</code>, <em>without</em> following the instructions for
<a href="./APT_repository/custom.html#workflow-merge-main-branch">merging base branches</a>.
(For now <code>feature/buster</code> is handled as any other topic branch
forked off <code>devel</code>: its base branch is set to <code>devel</code>.)
If the merge conflicts don't look like something you feel confident
resolving properly, abort this merge and let the Foundations
Team know.</p></li>
<li><p>Ensure that the release, <code>devel</code> and <code>feature/buster</code> branches
have the expected content in <code>config/APT_overlays.d/</code>: e.g. it must
not list any overlay APT suite that has been merged already.</p></li>
<li><p>Push the modified branches to Git:</p>

<pre><code> git push origin                          \
    "${RELEASE_BRANCH:?}:${RELEASE_BRANCH:?}" \
    feature/buster:feature/buster       \
    devel:devel
</code></pre></li>
</ol>


<h1><a name="index9h1"></a>Update more included files</h1>

<h2><a name="index12h2"></a>Changelog</h2>

<p>Remove the placeholder entry for next release in <code>debian/changelog</code>,
and then:</p>

<pre><code>git checkout "${RELEASE_BRANCH:?}" &amp;&amp; \
DEBEMAIL='tails@boum.org' DEBFULLNAME='Tails developers' \
./release ${VERSION:?} ${PREVIOUS_TAG:?}
</code></pre>

<p>This populates the Changelog with the Git log entries.</p>

<p>Then, launch an editor for the needed cleanup of the result:</p>

<pre><code>dch -e
</code></pre>

<p>Then, gather other useful information from:</p>

<ul>
<li>every custom bundled package's own Changelog (Greeter, Persistent
Volume Assistant, etc.);</li>
<li>the diff between the previous version's <code>.packages</code> file and the one
from the to-be-released ISO; look for:

<ul>
<li>security fixes</li>
<li>new upstream releases of applications mentioned in <a href="../doc/about/features.en.html">features</a></li>
<li>new upstream releases of other important components such as the
Linux kernel</li>
</ul>
</li>
<li>the "Fix committed" section on the <em>Release Manager View for ${VERSION:?}</em>
in Redmine.</li>
</ul>


<p>Finally, sanity check the version and commit:</p>

<pre><code>if [ "$(dpkg-parsechangelog -SVersion)" = "${VERSION:?}" ]; then
    git commit debian/changelog -m "Update changelog for ${VERSION:?}."
else
    echo 'Error: version mismatch: please compare ${VERSION:?} with the last entry in debian/changelog'
fi
</code></pre>

<h2><a name="index13h2"></a>Included website</h2>

<h3><a name="index1h3"></a>Merge master</h3>

<p>Merge <code>master</code> into the branch used for the release:</p>

<pre><code>git fetch origin &amp;&amp; git merge origin/master
</code></pre>

<h3><a name="index2h3"></a>version number</h3>

<p>If preparing a RC, skip this part.</p>

<p>In the branch used to build the release, update the <code>wiki/src/inc/*</code> files to
match the <em>version number</em> and <em>date</em> of the new release. Set the date
at least 24 hours in the future! Between tests and mirror synchronization,
the build will not be released on the same day. Try to make sure it
matches the date of the future signature.</p>

<pre><code>RELEASE_DATE='2015-11-03'

echo "${VERSION:?}"      &gt; wiki/src/inc/stable_amd64_version.html
echo -n "${RELEASE_DATE:?}" &gt; wiki/src/inc/stable_amd64_date.html
${EDITOR:?} wiki/src/inc/*.html
./build-website
git commit wiki/src/inc/ -m "Update version and date for ${VERSION:?}."
</code></pre>

<h2><a name="index14h2"></a>Website translations</h2>

<p>Refresh the website PO files and commit the ones corresponding to
pages that were added or changed accordingly to changes coming with
the new release. This e.g. ensures that the RC call for translation
points translators to up-to-date PO files:</p>

<pre><code>./build-website &amp;&amp; git add wiki/src &amp;&amp; git commit -m 'Update website PO files.'
git push origin "${RELEASE_BRANCH:?}:${RELEASE_BRANCH:?}"
</code></pre>

<h1><a name="index10h1"></a>Call for translation</h1>

<p>If at freeze time, send a call for translations to tails-l10n, making it clear what
Git branch the translations must be based on, and what are the
priorities. Also, add a few words to remember the translation teams
using Git that they should regularly contact Transifex translators,
as detailed on the <a href="./how/translate.html">documentation for
translators</a>.</p>

<p>To get a list of changes on the website:</p>

<pre><code>git diff --stat ${PREVIOUS_TAG:?}.. -- \
    wiki/src/'*'.{mdwn,html} \
    ':!wiki/src/blueprint*' \
    ':!wiki/src/contribute*' \
    ':!wiki/src/inc' \
    ':!wiki/src/news*' \
    ':!wiki/src/security*'
</code></pre>

<h1><a name="index11h1"></a>Enable OpenPGP signing</h1>

<h3><a name="index3h3"></a>If you have an OpenPGP smart card</h3>

<p>If you have an OpenPGP smart card (i.e. if you are one of the usual
release managers) go fetch it. Remember to only plug it when needed! A
pro tip is to never plug it unless prompted which <code>gpg</code> will do for
you. Then just unplug it as soon as the <code>.sig</code> is done.</p>

<h3><a name="index4h3"></a>Otherwise: importing the signing key</h3>

<p>This is only relevant when the master key has been reassembled,
e.g. for signing a Tails emergency release where none of the usual
release managers are available.</p>

<p>You should never import the Tails signing key into your own keyring,
and a good practice is to import it to a tmpfs to limit the risks that
the private key material is written to disk:</p>

<pre><code>export GNUPGHOME=$(mktemp -d)
sudo mount -t ramfs ramfs "${GNUPGHOME:?}"
sudo chown $(id -u):$(id -g) "${GNUPGHOME:?}"
sudo chmod 0700 "${GNUPGHOME:?}"
gpg --homedir ${HOME:?}/.gnupg --export ${TAILS_SIGNATURE_KEY:?} | gpg --import
gpg --import path/to/private-key
</code></pre>

<p>Let's also ensure that strong digest algorithms are used for our
signatures, like the defaults we set in Tails:</p>

<pre><code>cp config/chroot_local-includes/etc/skel/.gnupg/gpg.conf "${GNUPGHOME:?}"
</code></pre>

<h1><a name="index12h1"></a>Build the almost-final image</h1>

<ol>
<li><a href="./build.html">Build an ISO image</a> from the release branch.</li>
<li>Carefully read the build logs to make sure nothing bad happened.</li>
<li>Keep at least the resulting ISO image and the manifest of needed
packages until the end of this release process.</li>
<li><p>Record where the manifest of needed packages is stored:</p>

<pre><code> export PACKAGES_MANIFEST=XXX ; \
 [ -f "${PACKAGES_MANIFEST:?}" ] || echo "ERROR: PACKAGES_MANIFEST is incorrect"
</code></pre></li>
</ol>


<h1><a name="index13h1"></a>Tag the release in Git</h1>

<pre><code>git tag -u "${TAILS_SIGNATURE_KEY:?}" \
  -m "tagging version ${VERSION:?}" "${TAG:?}" &amp;&amp; \
git push origin "${TAG:?}" "${RELEASE_BRANCH:?}"
</code></pre>

<p>(Pushing the tag is needed so that the APT repository is updated, and
the Tails APT configuration works at build and boot time. It might be
premature, as testing might reveal critical issues, but this is
a signed tag, so it can be overridden later. Yes, there is room for
improvement here.)</p>

<p>XXX: From this push of a tag, the builds in Jenkins fail because we prevent it
to continue if the last debian/changelog entry has a tag. There are workarounds
we need to decide and implement.</p>

<h1><a name="index14h1"></a>Prepare the versioned APT suites</h1>

<ul>
<li><p><a href="./APT_repository/custom.html#workflow-post-tag">Prepare the versioned APT suite in our custom APT repository</a>.</p></li>
<li><p>Prepare tagged snapshots of upstream APT repositories:</p>

<pre><code>    ./bin/tag-apt-snapshots "${PACKAGES_MANIFEST:?}" "${TAG:?}"
</code></pre>

<p>Note:</p>

<ul>
<li>This command can take a while (about a dozen minutes).</li>
<li>It's expected that the packages that were pulled from our
<a href="./APT_repository/custom.html">custom APT repository</a> are
listed under "some packages were not found anywhere" (because we
are currently not using time-based snapshots for our custom APT
repository). However, <em>no other package should be on that list</em>.
Now, we have a "safety" net, in case you don't notice such a problem: if
other packages are missing, the next build (that will use the
newly created partial, tagged APT repository) will fail.</li>
</ul>
</li>
</ul>


<h1><a name="index15h1"></a>Build images</h1>

<h2><a name="index15h2"></a>Sanity check</h2>

<p>Verify that the Tor Browser release used in Tails still is the most
recent. Also look if there's a new <code>-buildX</code> tag for the targeted
Tor Browser version in these Git repositories:</p>

<ul>
<li><a href="https://gitweb.torproject.org/builders/tor-browser-bundle.git">https://gitweb.torproject.org/builders/tor-browser-bundle.git</a></li>
<li><a href="https://gitweb.torproject.org/tor-browser.git">https://gitweb.torproject.org/tor-browser.git</a></li>
</ul>


<p>A new tag may indicate that a new Tor Browser release is imminent.</p>

<p>Better catch this before people spend time doing manual tests.</p>

<h2><a name="index16h2"></a>SquashFS file order</h2>

<ol>
<li>Burn the almost final ISO image to a DVD.</li>
<li>Boot this DVD <strong>on bare metal</strong>.</li>
<li>Add <code>profile</code> to the kernel command-line.</li>
<li>Login.</li>
<li>Wait for the "Tor is ready" notification.</li>
<li>Start <em>Tor Browser</em>.</li>
<li>A few minutes later, once the <code>boot-profile</code> process has been
killed, retrieve the new sort file from <code>/var/log/boot-profile</code>.</li>
<li>Backup the old sort file: <code>cp config/binary_rootfs/squashfs.sort{,.old}</code></li>
<li>Copy the new sort file to <code>config/binary_rootfs/squashfs.sort</code>.</li>
<li>Cleanup a bit:

<ul>
<li>remove <code>var/log/live/config.pipe</code>: otherwise the boot is broken
or super-slow</li>
<li>remove the bits about <code>kill-boot-profile</code> at the end: they're
only useful when profiling the boot</li>
</ul>
</li>
<li><p>Inspect the Git diff (including diff stat), apply common sense:</p>

<pre><code> diff -NaurB \
     &lt;( cut -d' ' -f1 config/binary_rootfs/squashfs.sort.old | sort ) \
     &lt;( cut -d' ' -f1 config/binary_rootfs/squashfs.sort     | sort ) \
     | less
</code></pre></li>
<li><p><code>git commit -m 'Updating SquashFS sort file' config/binary_rootfs/squashfs.sort</code></p></li>
</ol>


<h2><a name="index17h2"></a>Build the final image</h2>

<p>Then all included files should be up-to-date and the versioned APT
suite should be ready, so it is time to:</p>

<ol>
<li><p>Mark the version as "released" in the changelog:</p>

<pre><code> dch --release --no-force-save-on-release --maintmaint &amp;&amp; \
 git commit -m "Mark Tails ${VERSION:?} as released." debian/changelog
</code></pre></li>
<li><p>Export <code>SOURCE_DATE_EPOCH</code>:</p>

<pre><code> export SOURCE_DATE_EPOCH=$(date --utc --date="$(dpkg-parsechangelog --show-field=Date)" '+%s')
</code></pre></li>
<li><p>tag the release <em>again</em>, with all included files in:</p>

<pre><code> git tag -f -u "${TAILS_SIGNATURE_KEY:?}" \
         -m "tagging version ${VERSION:?}" "${TAG:?}" &amp;&amp; \
 git push --force origin "${TAG:?}" &amp;&amp; \
 git push origin "${RELEASE_BRANCH:?}"
</code></pre>

<p>Note: for Jenkins to build the release you must push the release
branch with its tip tagged. I.e. if you deviate from the above
commands by e.g. committing a commit in between <code>git tag</code> and the
first <code>git push</code> then Jenkins won't build from the tag -- please
avoid that!</p></li>
<li><p>build the final image!</p></li>
<li><p>Compare the new build manifest with the one from the previous,
almost final build:</p>

<pre><code> diff -Naur \
    "${PACKAGES_MANIFEST:?}" \
    "${ARTIFACTS:?}/tails-amd64-${VERSION:?}.iso.build-manifest"
</code></pre>

<p>They should be identical, except that the <code>debian-security</code> serial might be higher.</p></li>
<li><p>To ensure we publish the final build's <code>.build-manifest</code>, run:</p>

<pre><code> export PACKAGES_MANIFEST="${ARTIFACTS:?}/tails-amd64-${VERSION:?}.iso.build-manifest"
</code></pre></li>
<li><p><a id="reproducibility-sanity-check-iso"></a>
Let's sanity check that Jenkins reproduced your image.</p>

<p>Visit the URL printed by this command:</p>

<pre><code>echo "https://jenkins.tails.boum.org/job/build_Tails_ISO_${RELEASE_BRANCH}/"
</code></pre>

<p>Find the job (probably the last one)
and make sure the image built by Jenkins:</p>

<ul>
<li>was built from the correct Git commit</li>
<li>has the same file size as the image you built</li>
<li>has the same hash (in the <code>.shasum</code> file) as the image you built</li>
</ul>


<p>Then:</p>

<ul>
<li><p>If all hashes match: yay, we're good to go!</p></li>
<li><p>If there is a hash mismatch for the image: ouch! Now we are in a
tricky situation: on the one hand it seems like a poor idea to
block users from benefiting from this release's security updates,
but on the other hand the failure might imply that something
nefarious is going on. At this stage, no matter what, immediately
fetch Jenkins' image, compare it with your, and try to rule out
build system compromise:</p>

<pre><code> sudo diffoscope \
     --text diffoscope.txt \
     --html diffoscope.html \
     --max-report-size 262144000 \
     --max-diff-block-lines 10000 \
     --max-diff-input-lines 10000000 \
         path/to/your/tails-amd64-${VERSION:?}.iso \
         path/to/jenkins/tails-amd64-${VERSION:?}.iso
</code></pre>

<p>Then carefully investigate the <code>diffoscope</code> report:</p>

<ul>
<li><p>If you cannot rule out that the difference is harmful: let's take
a step back; we might be compromised, so we are in no position to
release. Halt the release, involve the rest of <code>tails@</code>, and then
try to re-establish trust in all build machines and infra
involved, etc. Have fun!</p></li>
<li><p>Otherwise, if the change is definitely harmless:</p>

<ul>
<li><p>If the source of non-determinism is identified quickly and
is easy and fast to fix, <em>and</em> the QA of the current image
has not gone very far (so at least that time is not wasted),
then you should consider abandoning the current version, and
immediately start preparing an emergency release with:</p>

<ul>
<li>the reproducibility fix,</li>
<li>a new changelog entry,</li>
<li>adjustments to the release notes so they are re-purposed for
this emergency release (the abandoned release gets none, since
it effectively never will be released publicly).</li>
</ul>
</li>
<li><p>Otherwise, if the fix looks time-consuming or difficult,
let's release anyway. But let's add a known issue about
"This Tails release does not build reproducibility" to the
release notes, linking to the ticket where
the nature of the reproducibility failure is clearly
described.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>check out a new branch:</p>

<p>If preparing anything but a final release (e.g. an alpha, beta
or RC):</p>

<pre><code> git checkout -b "${WEBSITE_RELEASE_BRANCH:?}" origin/master &amp;&amp; \
 git push -u origin "${WEBSITE_RELEASE_BRANCH:?}"
</code></pre>

<p>Else, if preparing a final release:</p>

<pre><code> git checkout -b "${WEBSITE_RELEASE_BRANCH:?}" "${TAG:?}" &amp;&amp; \
 git push -u origin "${WEBSITE_RELEASE_BRANCH:?}"
</code></pre>

<p>(as soon as a new commit is created on <code>$RELEASE_BRANCH</code>, its ISO
build will start failing until a new changelog entry is created,
which we don't want to do on <code>$RELEASE_BRANCH</code> before it's merged
into <code>master</code> at release time)</p></li>
</ol>


<h1><a name="index16h1"></a>Generate the OpenPGP signatures and Torrents</h1>

<p>Create a directory with a suitable name, go there, move the built
image to this brand new directory, generate detached OpenPGP
signatures for the image to be published (in the same directory as the
image and with a <code>.sig</code> extension), then go up to the parent
directory, create a <code>.torrent</code> file and check the generated <code>.torrent</code>
files metadata:</p>

<pre><code>mkdir "${ISOS:?}/tails-amd64-${VERSION:?}" &amp;&amp; \
cd "${ISOS:?}/tails-amd64-${VERSION:?}" &amp;&amp; \
mv "${ARTIFACTS:?}/tails-amd64-${VERSION:?}.iso" \
   "${ISOS:?}/tails-amd64-${VERSION:?}/" &amp;&amp; \
gpg --armor --default-key "${TAILS_SIGNATURE_KEY:?}" --detach-sign *.iso &amp;&amp; \
rename 's,\.asc$,.sig,' *.asc &amp;&amp; \
cd .. &amp;&amp; \
mktorrent \
  -a 'udp://tracker.torrent.eu.org:451' \
  -a 'udp://tracker.coppersurfer.tk:6969'   \
  "tails-amd64-${VERSION:?}" &amp;&amp; \
transmission-show tails-amd64-${VERSION:?}.torrent
</code></pre>

<p>Lastly, let's set some variables to be used later:</p>

<pre><code>ISO_PATH="${ISOS:?}/tails-amd64-${VERSION:?}/tails-amd64-${VERSION:?}.iso"
ISO_SHA256SUM="$(sha256sum "${ISO_PATH:?}" | cut -f 1 -d ' ' | tr -d '\n')"
ISO_SIZE_IN_BYTES="$(stat -c %s "${ISO_PATH:?}")"
</code></pre>

<p><a id="prepare-iuk"></a></p>

<h1><a name="index17h1"></a>Prepare incremental upgrades</h1>

<h2><a name="index18h2"></a>Build the Incremental Upgrade Kits</h2>

<p>Incremental upgrades may be skipped if the delta is too big (like when
migrating to a new Debian release) or if there are changes outside of
the scope for IUKs (like partition table changes). Use common sense!</p>

<p>Use <code>tails-create-iuk</code> to build the following IUKs:</p>

<ul>
<li><p>From the two previous <em>planned</em> releases, and any emergency releases
in between and after. This should be, more or less, all releases for
the last 12 weeks (although irregularities in Firefox release
schedule may add or remove a few weeks).</p></li>
<li><p>From the last RC for the version being released, e.g. 1.0~rc1 to
1.0. This should be done even if there was no IUK generated from the
previous stable release since it is a good way to test the iuk code
that'll be used for the incremental upgrade paths to the
next version.</p></li>
</ul>


<p>Include each such version in a white-space separated list called
<code>IUK_SOURCE_VERSIONS</code>, (e.g. <code>IUK_SOURCE_VERSIONS="2.8 2.9 2.9.1 2.10~rc1"</code>)
and run the following:</p>

<pre><code>for source_version in $(echo ${IUK_SOURCE_VERSIONS:?}); do
    if [ "$(dpkg-query --showformat '${Version}\n' --show squashfs-tools)" != 1:4.3-3.0tails4 ]; then
        echo 'ERROR! Your squashfs-tools probably does not honor SOURCE_DATE_EPOCH so any generated IUKs will *not* be reproducible!'
        break
    fi
    sudo su -c "cd ${IUK_CHECKOUT:?} &amp;&amp; \
      SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH \
      LC_ALL=C \
      PERL5LIB=\"${PERL5LIB_CHECKOUT:?}/lib\" \
        ./bin/tails-create-iuk \
           --squashfs-diff-name \"${VERSION:?}.squashfs\"           \
           --old-iso \"${ISOS:?}/tails-amd64-${source_version:?}/tails-amd64-${source_version:?}.iso\" \
           --new-iso \"${ISOS:?}/tails-amd64-${VERSION:?}/tails-amd64-${VERSION:?}.iso\"          \
           --outfile \"${ISOS:?}/Tails_amd64_${source_version:?}_to_${VERSION:?}.iuk\""
done
</code></pre>

<p>Note that developer tools for creating IUK and upgrade-description
files were only tested on Debian sid. It should hopefully work well on
Debian stable too.</p>

<p><a id="reproducibility-sanity-check-iuk"></a></p>

<p>Note that we do not yet build IUKs on Jenkins, otherwise here would be
a great point to compare its IUKs with yours.</p>

<p><a id="prepare-upgrade-description-files"></a></p>

<h2><a name="index19h2"></a>Prepare upgrade-description files</h2>

<ol>
<li><p>Prepare upgrade-description files (see the <a href="./design/incremental_upgrades.html#upgrade-description-files">upgrade-description
files
specification</a>
for details). The idea is to:</p>

<ul>
<li>update (create if needed) an upgrade-description file for every
<em>previous</em> supported release (e.g. N~rc1, N-1, N-1~rc2) that replaces
all existing upgrade paths with the path to the version being
released;</li>
<li>create a new upgrade-description for the version being released
and for the next one, that expresses that <em>no</em> upgrade is
available for these ones yet.</li>
</ul>


<p>This is what <code>tails-iuk-generate-upgrade-description-files</code> tool
does:</p>

<pre><code> ( cd ${IUK_CHECKOUT:?} &amp;&amp; \
 ./bin/tails-iuk-generate-upgrade-description-files \
     --build-target amd64 \
     --version "${VERSION:?}" \
     --next-version "${NEXT_PLANNED_MAJOR_VERSION:?}" \
     --next-version "${NEXT_PLANNED_MAJOR_VERSION:?}~rc1" \
     --next-version "${NEXT_PLANNED_MINOR_VERSION:?}" \
     --next-version "${VERSION:?}.1" \
     --iso "${ISO_PATH:?}" \
     --previous-version "${PREVIOUS_VERSION:?}" \
     --previous-version "${VERSION:?}~rc1" \
     --iuks "${ISOS:?}" \
     --release-checkout "${RELEASE_CHECKOUT:?}" \
     --major-release "${MAJOR_RELEASE:?}" \
)
</code></pre>

Note:

<ul>
<li>The <code>--iuks</code> argument must point to the directory where the IUKs
generated at the previous step are stored.</li>
<li>At least the last stable release and the previous release
candidates for the version being released must be passed to
<code>--previous-version</code>.</li>
<li>Older versions for which there is no incremental upgrade path to
the new release must be passed with <code>--previous-version</code>, so that
users who skipped a release or two are informed of the new one.
Note that multi-steps incremental upgrade paths are valid and
supported: e.g. when releasing 1.1.2, 1.1 users should still be
able to incrementally upgrade to 1.1.1, and in turn to 1.1.2; to
make this work, unless there's a IUK from 1.1 to 1.1.2,
one must <em>not</em> pass <code>--previous-version 1.1</code>,
that would remove the existing incremental upgrade path from 1.1
to 1.1.1.</li>
<li>If preparing anything but a final release (e.g. an alpha, beta
or RC), add <code>--channel alpha</code></li>
<li>If preparing anything but a final release (e.g. an alpha, beta
or RC), drop all <code>--next-version</code>
arguments, and instead pass
<code>--next-version $(echo ${VERSION:?} | sed -e 's,~rc.*$,,')</code></li>
<li>Adjust <code>--next-version "${VERSION:?}.1"</code> so it matches the next
potential emergency release. E.g. when releasing 3.7.1,
pass <code>--next-version 3.7.2</code> and when releasing 3.8, pass
<code>--next-version 3.8.1</code>.</li>
</ul>
</li>
<li><p>Create an armoured detached signature for each created or modified
upgrade-description file.</p>

<pre><code> find "${RELEASE_CHECKOUT:?}/wiki/src/upgrade/" \
    -type f -name upgrades.yml | \
    while read udf; do
        if [ -n "$(git status --porcelain "${udf:?}")" ]; then
            for x in 1 2 3; do
                gpg -u "${TAILS_SIGNATURE_KEY:?}" --armor \
                    --detach-sign "${udf:?}" \
                &amp;&amp; break
            done
            mv --force "${udf:?}.asc" "${udf:?}.pgp"
            ( \
              cd ${IUK_CHECKOUT:?} &amp;&amp; \
              ./bin/tails-iuk-check-upgrade-description-file "${udf:?}" \
            ) || break
        fi
    done
</code></pre></li>
<li><p>Add and commit the upgrade-description files and their detached
signatures to the Git branch used to prepare the release
(<code>$WEBSITE_RELEASE_BRANCH</code>):</p>

<pre><code> ( \
   cd "${RELEASE_CHECKOUT:?}" &amp;&amp; git add wiki/src/upgrade &amp;&amp; \
   git commit -m "Update upgrade-description files." &amp;&amp; \
   git push origin ${WEBSITE_RELEASE_BRANCH:?} \
 )
</code></pre></li>
<li><p>If preparing anything but a final release (e.g. an alpha, beta
or RC), copy the generated UDFs for the previous releases
to the <em>test</em> channel in <code>$MASTER_CHECKOUT</code>, modify their content
accordingly, sign them, commit and push:</p>

<pre><code> ( \
   cd ${MASTER_CHECKOUT:?} &amp;&amp; \
   git fetch &amp;&amp; \
   for old_version in $(echo ${IUK_SOURCE_VERSIONS:?}); do
     alpha_udf="wiki/src/upgrade/v1/Tails/${old_version:?}/amd64/alpha/upgrades.yml" &amp;&amp; \
     test_udf="wiki/src/upgrade/v1/Tails/${old_version:?}/amd64/test/upgrades.yml" &amp;&amp; \
     mkdir -p "$(dirname "$test_udf")" &amp;&amp; \
     git show origin/${WEBSITE_RELEASE_BRANCH:?}:${alpha_udf:?} \
       | sed -e 's/channel: alpha/channel: test/' &gt; ${test_udf:?} &amp;&amp; \
     gpg -u "${TAILS_SIGNATURE_KEY:?}" --armor --detach-sign ${test_udf:?} &amp;&amp; \
     mv ${test_udf:?}.asc ${test_udf:?}.pgp &amp;&amp; \
     git add ${test_udf:?}* ; \
   done &amp;&amp; \
   git commit -m "Add incremental upgrades on the test channel for Tails ${VERSION:?}" &amp;&amp; \
   git push origin master:master \
 )
</code></pre></li>
<li><p>Else, if preparing a final release, copy the generated UDFs for the previous
releases to the <em>test</em> channel in <code>$MASTER_CHECKOUT</code>, modify their content
accordingly, sign them, commit and push:</p>

<pre><code> ( \
   cd ${MASTER_CHECKOUT:?} &amp;&amp; \
   git fetch &amp;&amp; \
   for old_version in $(echo ${IUK_SOURCE_VERSIONS:?}); do
     stable_udf="wiki/src/upgrade/v1/Tails/${old_version:?}/amd64/stable/upgrades.yml" &amp;&amp; \
     test_udf="wiki/src/upgrade/v1/Tails/${old_version:?}/amd64/test/upgrades.yml" &amp;&amp; \
     mkdir -p "$(dirname "$test_udf")" &amp;&amp; \
     git show origin/${WEBSITE_RELEASE_BRANCH:?}:${stable_udf:?} \
       | sed -e 's/channel: stable/channel: test/' &gt; ${test_udf:?} &amp;&amp; \
     gpg -u "${TAILS_SIGNATURE_KEY:?}" --armor --detach-sign ${test_udf:?} &amp;&amp; \
     mv ${test_udf:?}.asc ${test_udf:?}.pgp &amp;&amp; \
     git add ${test_udf:?}* ; \
   done &amp;&amp; \
   git commit -m "Add incremental upgrades on the test channel for Tails ${VERSION:?}" &amp;&amp; \
   git push origin master:master \
 )
</code></pre></li>
</ol>


<h2><a name="index20h2"></a>Prepare the ISO description file for <em>Tails Verification</em></h2>

<p>If preparing a RC, skip this part.</p>

<p>Update the ISO description file (IDF) used by the browser extension:</p>

<pre><code>cat &gt; "${RELEASE_CHECKOUT:?}"/wiki/src/install/v1/Tails/amd64/stable/latest.yml &lt;&lt;EOF
---
build-target: amd64
channel: stable
product-name: Tails
version: '${VERSION:?}'
target-files:
- sha256: ${ISO_SHA256SUM}
  size: ${ISO_SIZE_IN_BYTES:?}
  url: http://dl.amnesia.boum.org/tails/stable/tails-amd64-${VERSION:?}/tails-amd64-${VERSION:?}.iso
EOF
( cd "${RELEASE_CHECKOUT:?}" &amp;&amp; \
  git add wiki/src/install/v1/Tails/amd64/stable/latest.yml &amp;&amp; \
  git commit -m "Update IDF file for Tails Verification." )
</code></pre>

<h1><a name="index18h1"></a>Done with OpenPGP signing</h1>

<p>By now you are done with Tails signing key, so please make sure it is
not usable by your system any more.</p>

<div class="note">

Beware! If your have to plug your OpenPGP smart card or reassemble the
key again after this point it invalidates <i>everything</i> done for
the <a href="./release_process/test.html#reproducibility-final-check">reproduction of this release</a>
so it has to be started from the beginning:

* the original text is restored on the pad, and
* some tester follows it from scratch, and
* the Trusted Reproducer follows awaits the new input from said tester
  and then starts from scratch.

So please try to avoid this!

</div>


<h1><a name="index19h1"></a>Upload images</h1>

<h2><a name="index21h2"></a>Sanity check</h2>

<p>Verify once more that the Tor Browser we ship is still the most recent (see
above).</p>

<p><a id="publish-iuk"></a></p>

<h2><a name="index22h2"></a>Publish the ISO and IUKs over HTTP</h2>

<p>Upload the IUKs to our rsync server:</p>

<pre><code>for source_version in $(echo ${IUK_SOURCE_VERSIONS:?}); do
   rsync --partial --inplace --progress -v \
      "${ISOS:?}/Tails_amd64_${source_version:?}_to_${VERSION:?}.iuk" \
      rsync.lizard:
done
</code></pre>

<p>While waiting for the IUKs to be uploaded, you can proceed with the next steps.</p>

<p>Upload the ISO signature to our rsync server:</p>

<pre><code>scp "${ISO_PATH:?}.sig" rsync.lizard:
</code></pre>

<p>Pick a build from <code>$RELEASE_BRANCH</code> that produced an ISO identical to
the one you've built locally (<code>XXX</code> must be the job ID, i.e.
an integer):</p>

<pre><code>MATCHING_JENKINS_BUILD_ID=XXX
</code></pre>

<p>Copy the ISO to our rsync server, verify its signature,
move them in place with proper ownership and permissions
and update the time in <code>project/trace</code> file on our rsync server
and on the live website (even for a release candidate):</p>

<pre><code>cat "${RELEASE_CHECKOUT:?}/wiki/src/tails-signing.key" \
   | ssh rsync.lizard gpg --import
ssh rsync.lizard &lt;&lt; EOF
   wget \
      "https://nightly.tails.boum.org/build_Tails_ISO_${RELEASE_BRANCH:?}/builds/${MATCHING_JENKINS_BUILD_ID:?}/archive/build-artifacts/tails-amd64-${VERSION:?}.iso" &amp;&amp; \
   gpg --verify tails-amd64-${VERSION:?}.iso{.sig,}
EOF

ssh rsync.lizard &lt;&lt; EOF
  sudo install -o root -g rsync_tails -m 0755 -d \
     /srv/rsync/tails/tails/${DIST:?}/tails-amd64-${VERSION:?} &amp;&amp; \
  sudo chown root:rsync_tails tails-amd64-${VERSION:?}.iso* &amp;&amp; \
  sudo chmod u=rwX,go=rX tails-amd64-${VERSION:?}.iso* &amp;&amp; \
  sudo mv tails-amd64-${VERSION:?}.iso* \
          /srv/rsync/tails/tails/${DIST:?}/tails-amd64-${VERSION:?}
EOF

TRACE_TIME=$(date +%s) &amp;&amp;
echo ${TRACE_TIME:?} | ssh rsync.lizard "cat &gt; /srv/rsync/tails/tails/project/trace" &amp;&amp; \
[ -n "${MASTER_CHECKOUT:?}" ] &amp;&amp; \
echo ${TRACE_TIME:?} &gt; "${MASTER_CHECKOUT:?}/wiki/src/inc/trace" &amp;&amp;
(
   cd "${MASTER_CHECKOUT:?}" &amp;&amp; \
   git commit wiki/src/inc/trace \
      -m "Updating trace file after uploading the ISO for ${VERSION:?}." &amp;&amp; \
   git push origin master
)
</code></pre>

<p>Once the IUKs are uploaded, move them IUKs in place with proper
ownership and permissions and update the time in <code>project/trace</code> file
on our rsync server and on the live website (even for a release
candidate):</p>

<pre><code>ssh rsync.lizard &lt;&lt; EOF
  sudo chown root:rsync_tails Tails_amd64_*_to_${VERSION:?}.iuk &amp;&amp; \
  sudo chmod u=rwX,go=rX Tails_amd64_*_to_${VERSION:?}.iuk &amp;&amp; \
  sudo mv Tails_amd64_*_to_${VERSION:?}.iuk \
          /srv/rsync/tails/tails/${DIST:?}/iuk/
EOF

TRACE_TIME=$(date +%s) &amp;&amp;
echo ${TRACE_TIME:?} | ssh rsync.lizard "cat &gt; /srv/rsync/tails/tails/project/trace" &amp;&amp; \
[ -n "${MASTER_CHECKOUT:?}" ] &amp;&amp; \
echo ${TRACE_TIME:?} &gt; "${MASTER_CHECKOUT:?}/wiki/src/inc/trace" &amp;&amp;
(
   cd "${MASTER_CHECKOUT:?}" &amp;&amp; \
   git commit wiki/src/inc/trace \
      -m "Updating trace file after uploading the IUKs for ${VERSION:?}." &amp;&amp; \
   git push origin master
)
</code></pre>

<h2><a name="index23h2"></a>Announce, seed and test the Torrent</h2>

<p>Check if there's enough space on our Bittorrent seed to import the new
ISO:</p>

<pre><code>ssh bittorrent.lizard df -h /var/lib/transmission-daemon/downloads
</code></pre>

<p>If not, list already running Torrents:</p>

<pre><code>ssh bittorrent.lizard transmission-remote --list
</code></pre>

<p>… set <code>$ID</code> to the oldest one and delete it:</p>

<pre><code>ssh bittorrent.lizard -t "${ID:?}" --remove-and-delete
</code></pre>

<p>… and finally check disk space again:</p>

<pre><code>ssh bittorrent.lizard df -h /var/lib/transmission-daemon/downloads
</code></pre>

<p>Now you can announce and seed the Torrent for the release you're preparing:</p>

<pre><code>cat "${RELEASE_CHECKOUT:?}/wiki/src/tails-signing.key" \
   | ssh bittorrent.lizard gpg --import
scp \
   "${ISOS:?}/tails-amd64-${VERSION:?}.torrent" \
   "${ISO_PATH:?}.sig" \
   bittorrent.lizard: &amp;&amp; \
ssh bittorrent.lizard &lt;&lt; EOF
   mkdir --mode 0755 "tails-amd64-${VERSION:?}" &amp;&amp; \
   mv "tails-amd64-${VERSION:?}.iso.sig" \
      "tails-amd64-${VERSION:?}/" &amp;&amp; \
   cd "tails-amd64-${VERSION:?}" &amp;&amp; \
   wget \
      "https://nightly.tails.boum.org/build_Tails_ISO_${RELEASE_BRANCH:?}/builds/${MATCHING_JENKINS_BUILD_ID:?}/archive/build-artifacts/tails-amd64-${VERSION:?}.iso" &amp;&amp; \
   gpg --verify tails-amd64-${VERSION:?}.iso{.sig,} &amp;&amp; \
   cd &amp;&amp; \
   chgrp -R debian-transmission "tails-amd64-${VERSION:?}" &amp;&amp; \
   chmod -R go+rX,g+w "tails-amd64-${VERSION:?}" &amp;&amp; \
   mv \
      "tails-amd64-${VERSION:?}" \
      /var/lib/transmission-daemon/downloads/ &amp;&amp; \
   transmission-remote --add tails-amd64-${VERSION:?}.torrent \
                       --find /var/lib/transmission-daemon/downloads/
EOF
</code></pre>

<p>Test that you can start downloading the ISO with a BitTorrent client.</p>

<h2><a name="index24h2"></a>ISO history</h2>

<p>Push the released ISO to our Tails ISO history git-annex repo, so that
our isotesters can fetch it from there for their testing. How to do so
is described in our internal Git repo.
XXX: move this document to a repo that all RMs have access to.</p>

<h1><a name="index20h1"></a>Testing</h1>

<ol>
<li><p>Using <code>check-mirrors</code>, choose a fast mirror that already has the
tentative ISO. E.g. <a href="https://mirrors.kernel.org/tails/">https://mirrors.kernel.org/tails/</a> or
<a href="https://mirrors.wikimedia.org/tails/">https://mirrors.wikimedia.org/tails/</a> are reliable and have plenty
of bandwidth.</p>

<pre><code> ./check-mirrors.rb --allow-multiple --channel ${DIST:?} \
     --ip $(dig +short mirrors.kernel.org | tail -n1) \
     tails-amd64-${VERSION:?}
</code></pre></li>
<li><p>Email <a href="mailto:tails-testers@boum.org">&#116;&#97;&#105;&#108;&#115;&#45;&#116;&#101;&#115;&#116;&#101;&#114;&#115;&#64;&#98;&#111;&#117;&#109;&#46;&#111;&#114;&#103;</a> to ask them to test the tentative
ISO, pointing them to the up-to-date mirror you've found previously.</p></li>
<li>Email <a href="mailto:tails@boum.org">&#116;&#97;&#105;&#108;&#115;&#64;&#98;&#111;&#117;&#109;&#46;&#111;&#114;&#103;</a> and potential contributors (see
<code>manual_testers.mdwn</code> in the internal Git repository) that tests
may start:

<ul>
<li>make sure the Trusted Verifier is in the list of recipients</li>
<li>point them to the up-to-date mirror you've found previously</li>
<li>make it clear what's the deadline</li>
<li>make it clear where and how you expect to get feedback</li>
<li>attach the Torrent</li>
<li>attach the <code>.packages</code> file</li>
</ul>
</li>
<li>Make sure someone is committed to run the automated test suite.</li>
<li>Make sure that enough people are here to run the tests, that they
report their results in due time, and that they make it clear when
they're leaving for good.</li>
<li>Fill the holes and make sure that the manual test suite is done in
due time.</li>
<li>Triage test results, reproduce bugs as needed, decide what the next
step is and make sure it happens: add to known issues? file ticket?
release blocker? improve the test description (steps, expected outcome)?</li>
</ol>


<h1><a name="index21h1"></a>Update the website and Git repository</h1>

<p>What follows in this section happens on the <code>$WEBSITE_RELEASE_BRANCH</code>
branch in <code>${RELEASE_CHECKOUT:?}</code>:</p>

<pre><code>cd "${RELEASE_CHECKOUT:?}" &amp;&amp; \
   git checkout "${WEBSITE_RELEASE_BRANCH:?}"
</code></pre>

<h2><a name="index25h2"></a>If preparing a final release</h2>

<p>Skip this part if preparing a RC.</p>

<p>Rename, copy, garbage collect and update various files:</p>

<pre><code>mv "${ARTIFACTS:?}"/tails-amd64-"${VERSION:?}".iso.packages \
   "${ARTIFACTS:?}/tails-amd64-${VERSION:?}.packages" &amp;&amp; \
mv "${PACKAGES_MANIFEST:?}" \
   "${ARTIFACTS:?}/tails-amd64-${VERSION:?}.build-manifest" &amp;&amp; \
cp "${ISO_PATH:?}.sig" \
   "${ARTIFACTS:?}/tails-amd64-${VERSION:?}.build-manifest" \
   "${ARTIFACTS:?}/tails-amd64-${VERSION:?}.packages" \
   "${ISOS:?}/tails-amd64-${VERSION:?}.torrent" \
   "${RELEASE_CHECKOUT:?}/wiki/src/torrents/files/" &amp;&amp; \
git rm \
   "${RELEASE_CHECKOUT:?}/wiki/src/torrents/files/tails-amd64-${PREVIOUS_VERSION:?}."{build-manifest,iso.sig,packages,torrent} &amp;&amp; \
LC_NUMERIC=C ls -l -h ${ISO_PATH:?} | \
   cut -f 5 -d ' ' | sed -r 's/(.+)([MG])/\1 \2B/' \
   &gt; "${RELEASE_CHECKOUT:?}/wiki/src/inc/stable_amd64_iso_size.html" &amp;&amp; \
gpg --check-trustdb &amp;&amp; \
LANG=C TZ=UTC gpg --no-options --keyid-format 0xlong --verify "${ISO_PATH:?}.sig" "${ISO_PATH:?}" 2&gt;&amp;1 | \
   sed 's/ /\&amp;nbsp;/g;s/&lt;/\&amp;lt;/;s/&gt;/\&amp;gt;/;s/$/&lt;br\/&gt;/g' &gt; \
   "${RELEASE_CHECKOUT:?}/wiki/src/inc/stable_amd64_gpg_signature_output.html"
</code></pre>

<p>Ensure our <a href="./working_together/roles/technical_writer.html">technical writer</a> has
<a href="./how/documentation/release_notes.html">written</a> the
announcement for the release in <code>wiki/src/news/version_${TAG:?}.mdwn</code>.</p>

<p>Write an announcement listing the security bugs affecting the previous
version in
<code>wiki/src/security/Numerous_security_holes_in_${PREVIOUS_VERSION:?}.mdwn</code>
in order to let the users of the old versions
know that they have to upgrade. Date it a few days before the ISO
image to be released was <em>built</em>. Including:</p>

<ul>
<li>if we are not shipping Linux from Debian stable, the list of
CVE fixed in Linux since the one shipped in the previous release of
Tails; you can find them in the relevant changelog e.g.:

<ul>
<li><a href="http://metadata.ftp-master.debian.org/changelogs/main/l/linux/unstable_changelog">http://metadata.ftp-master.debian.org/changelogs/main/l/linux/unstable_changelog</a></li>
<li><a href="http://metadata.ftp-master.debian.org/changelogs/main/l/linux/testing_changelog">http://metadata.ftp-master.debian.org/changelogs/main/l/linux/testing_changelog</a></li>
<li><a href="http://metadata.ftp-master.debian.org/changelogs/main/l/linux/stretch-backports_changelog">http://metadata.ftp-master.debian.org/changelogs/main/l/linux/stretch-backports_changelog</a></li>
</ul>
</li>
<li>the list of DSA fixed in packages we ship since those that were in
the previous release of Tails: <a href="https://www.debian.org/security/#DSAS">https://www.debian.org/security/#DSAS</a></li>
<li>the list of BSA fixed in packages we ship since those that were in
the previous release of Tails:
<a href="https://lists.debian.org/debian-backports-announce/">https://lists.debian.org/debian-backports-announce/</a></li>
<li>the list of MFSA fixed by the Tor Browser update:
<a href="https://www.mozilla.org/security/announce/">https://www.mozilla.org/security/announce/</a></li>
</ul>


<h2><a name="index26h2"></a>If preparing a release candidate</h2>

<p>Skip this part if preparing a final release.</p>

<p>Copy the signature and the Torrent into the website repository:</p>

<pre><code>cp "${ISO_PATH:?}.sig" \
   "${ISOS:?}/tails-amd64-${VERSION:?}.torrent" \
      "${RELEASE_CHECKOUT:?}/wiki/src/torrents/files/"
</code></pre>

<p>Write the announcement for the release in
<code>${RELEASE_CHECKOUT:?}/wiki/src/news/test_${TAG:?}.mdwn</code>, including:</p>

<ul>
<li>Update the <code>meta title</code> directive.</li>
<li>Update the <code>meta date</code> directive.</li>
<li>Document important config changes that persistence users have to do
themselves (e.g. the Pidgin proxy settings change in
<a href="https://git-tails.immerda.ch/tails/commit/?id=9925321">9925321</a> breaks all existing persistent
profiles).</li>
<li>Document known issues.</li>
<li><p>This snippet can help to convert the copied changelog's ticket
references to links:</p>

<pre><code>sed -i 's@#\([0-9]\{4,5\}\)@&lt;a href="https://labs.riseup.net/code/issues/\1"&gt;#\1&lt;/a&gt;@g' \
    wiki/src/news/test_${TAG:?}.mdwn
</code></pre></li>
</ul>


<h2><a name="index27h2"></a>In any case</h2>

<p>Generate PO files for the announcements and record the last commit
before putting the release out for real:</p>

<pre><code>./build-website &amp;&amp; \
git add wiki/src &amp;&amp; \
git commit -m "Releasing version ${VERSION:?}"
</code></pre>

<p>Then, send the PO files for the announcements to <a href="mailto:tails-l10n@boum.org">&#116;&#97;&#105;&#108;&#115;&#45;&#108;&#49;&#48;&#110;&#64;&#98;&#111;&#117;&#109;&#46;&#111;&#114;&#103;</a>
so that they get translated shortly, perhaps even soon enough to
integrate them before pushing the release out officially.</p>

<h1><a name="index22h1"></a>Go wild!</h1>

<h2><a name="index28h2"></a>Wait for the HTTP mirrors to catch up</h2>

<p>Test downloading the ISO and IUK over HTTP.</p>

<p>Make sure every active mirror in the pool has the new version:</p>

<pre><code>./check-mirrors.rb --channel ${DIST:?} --allow-multiple --fast \
    tails-amd64-${VERSION:?}
</code></pre>

<p>Ask <a href="mailto:tails-mirrors@boum.org">&#116;&#97;&#105;&#108;&#115;&#45;&#109;&#105;&#114;&#114;&#111;&#114;&#115;&#64;&#98;&#111;&#117;&#109;&#46;&#111;&#114;&#103;</a> to drop those that are lagging behind and
notify their administrators.</p>

<h2><a name="index29h2"></a>Sanity checks</h2>

<ul>
<li>Check the outcome of the "Testing" section above.</li>
<li>Wait for the Mozilla security advisory
<a href="https://www.mozilla.org/en-US/security/advisories/">to be published</a>.</li>
<li>While waiting, if preparing a major release, you can drop the post for Tor blog:
see the "Tor blog" section below. If you do that, uncheck the <em>Publish</em>
checkbox and click <em>Save</em> to save the draft.</li>
<li>Verify once more that the Tor Browser we ship is still the most recent (see
above).</li>
</ul>


<h2><a name="index30h2"></a>Push</h2>

<h3><a name="index5h3"></a>Git</h3>

<p>Push the last commits to our Git repository and put <code>master</code> in the
following state:</p>

<pre><code>( cd "${RELEASE_CHECKOUT:?}" &amp;&amp; \
  git push origin \
      "${WEBSITE_RELEASE_BRANCH:?}:${WEBSITE_RELEASE_BRANCH:?}" \
      devel:devel \
) &amp;&amp; \
( cd "${MASTER_CHECKOUT:?}" &amp;&amp; \
  git fetch &amp;&amp; \
  git merge origin/master &amp;&amp; \
  git merge "origin/${WEBSITE_RELEASE_BRANCH:?}" &amp;&amp; \
  echo "stable" &gt; config/base_branch &amp;&amp; \
  git commit config/base_branch \
      -m "Restore master's base branch." \
)
</code></pre>

<p>Finally, push the <code>master</code> branch to make the changes go live on our
website:</p>

<pre><code>( cd "${MASTER_CHECKOUT:?}" &amp;&amp; \
  git push origin master:master \
)
</code></pre>

<p>The release is now public! Woo!</p>

<h2><a name="index31h2"></a>Check translation are correct</h2>

<p>Once the push is over and the live website is build, check that each
<code>news/version_${VERSION}</code> HTML pages looks OK in all supported
languages.</p>

<h2><a name="index32h2"></a>Bug tracker</h2>

<p>Skip this part if preparing a release candidate.</p>

<p>Mark all issues fixed in this release as <code>Status: Resolved</code> in our bug
tracker. For a list of candidates, see:</p>

<ul>
<li>the <a href="https://labs.riseup.net/code/projects/tails/issues?query_id=111">issues in <em>Fix committed</em>
status</a>;</li>
<li>the "Fix committed" section on the <em>Release Manager View for ${VERSION:?}</em>
in Redmine.</li>
</ul>


<p>Then, mark the just-released Redmine milestone as done: go to the
target version page, click <em>Edit</em>, and set <em>Status</em> to <em>Closed</em>.</p>

<h3><a name="index6h3"></a>Tickets linked from the website</h3>

<p>Go through the tickets linked from the documentation and support sections of the
website and point documentation writers to the tickets that might be resolved in
this release.</p>

<pre><code>find wiki/src/{doc,support} -name "*.mdwn" -o -name "*.html" | xargs cat | \
    ruby -e 'puts STDIN.read.scan(/\[\[!tails_ticket\s+(\d+)[^\]]*\]\]/)' | \
    while read ticket; do
        url="https://labs.riseup.net/code/issues/${ticket:?}"
        url_content=$(curl --fail --silent ${url:?})
        if [ "${?}" -ne 0 ] || [ -z "${url_content:-}" ]; then
            echo "Failed to fetch ${url:?} so manually investigate #${ticket:?}" &gt;&amp;2
            continue
        fi
        ticket_status="$(echo "${url_content:?}" | \
            sed -n 's,^.*&lt;div class="status attribute"&gt;&lt;div class="label"&gt;Status:&lt;/div&gt;&lt;div class="value"&gt;\([^&lt;&gt;]\+\)&lt;/div&gt;&lt;/div&gt;.*$,\1,p')"
        if [ -z "${ticket_status:-}" ]; then
            echo "Failed to find the status of #${ticket:?}" &gt;&amp;2
            continue
        fi
        if [ "${ticket_status:?}" != "New" ] &amp;&amp; \
           [ "${ticket_status:?}" != "Confirmed" ] &amp;&amp; \
           [ "${ticket_status:?}" != "In Progress" ]; then
            echo "It seems ticket #${ticket:?} has been fixed (Status: ${ticket_status:?}) so please find all instances in the wiki and fix them. Ticket URL: ${url:?}"
        fi
    done
</code></pre>

<p>Remember that ticket expressions, e.g. <code>&lt;a href="https://labs.riseup.net/code/issues/1234"&gt;#1234&lt;/a&gt;</code>, can
span several lines, so finding the ones reported by the above code
<em>might</em> be harder than <code>git grep "tails_ticket 1234"</code>.</p>

<h2><a name="index33h2"></a>Twitter</h2>

<p>Check in the comments of the ticket for the release notes if the
technical writers have prepared a tweet. Otherwise tweet a simple link
to the release notes:</p>

<pre><code>Tails x.y is out: https://tails.boum.org/news/version_x.y
</code></pre>

<h2><a name="index34h2"></a>Tor blog</h2>

<p>XXX: move most of this to the list of things that can be done while
waiting for manual test results, replace "Save and publish" there with
"Save and keep unpublished", and keep only the "Save and publish" step
here (+ adjust <em>Authoring Information</em> → <em>Authored on</em> since the date
of the draft creation won't be correct). I didn't do this yet as it
would conflict with the changes I've done for <a href="https://labs.riseup.net/code/issues/12629">#12629</a>
in painful ways.</p>

<p>We announce <em>major</em> releases on the Tor blog:</p>

<ul>
<li><p>Generate a Tor Blog-friendly post; please go through it manually,
and look at the previews, to make sure it looks sane!</p>

<pre><code>ikiwiki --setup ikiwiki.setup \
        --render wiki/src/news/version_${VERSION:?}.mdwn | \
    tidy --wrap 99999 | \
    sed '0,/^&lt;div id="content" role="main"&gt;$/d' | \
    sed '/^&lt;div id="footer" class="pagefooter" role="contentinfo"&gt;$/,$d' | \
    sed '/^&lt;div class="toc"&gt;$/,+7d' | \
    sed '/^&lt;p&gt;&lt;img [^&lt;&gt;]*\/&gt;&lt;\/p&gt;$/d' | \
    sed '/^&lt;\/div&gt;$/d' | \
    sed 's@&lt;a name[^&lt;&gt;]*&gt;&lt;/a&gt;@@g' | \
    sed 's@href="\.\./@href="https://tails.boum.org/@g' | \
    sed 's@src="\./@src="https://tails.boum.org/news/@g' | \
    sed 's@\(\.en\)\?.html@/@g' \
    &gt; /tmp/tor-blog-post.html
    cat &gt;&gt; /tmp/tor-blog-post.html &lt;&lt;EOF
&lt;h1&gt;Support and feedback&lt;/h1&gt;
&lt;p&gt;For support and feedback, visit the &lt;a href="https://tails.boum.org/support/"&gt;Support section&lt;/a&gt; on the Tails website.&lt;/p&gt;
EOF
</code></pre></li>
<li><p><a href="https://blog.torproject.org/user">login to the Tor blog</a></p></li>
<li>click <em>Content</em> → <em>Add content</em> → <em>Blog Post</em></li>
<li>add these tags:

<ul>
<li>tails</li>
<li>anonymous operating system</li>
<li>tails releases</li>
</ul>
</li>
<li>set <em>Title</em> to "New Release: Tails $VERSION"</li>
<li>choose <em>Filtered HTML</em> as the <em>Text format</em> in the blog post editor</li>
<li>copy the text you have prepared into the <em>Post Body</em> textarea of the
blog post editor</li>
<li>open <em>Comment Settings</em> and verify that comments are <em>Closed</em></li>
<li>open <em>Promotion Options</em> and check <em>Promoted to front page</em></li>
<li>click <em>Preview</em> and ensure everything is OK</li>
<li>click <em>Save and publish</em></li>
</ul>


<h2><a name="index35h2"></a>Amnesia news</h2>

<p>The release announcement are automatically sent to <code>amnesia-news@</code>
(thanks to the <code>announce</code> flag) on an hourly basis, but it will be
stuck in the moderation
queue. <a href="https://mailman.boum.org/admindb/amnesia-news">Log in</a> and
accept it.</p>

<h1><a name="index23h1"></a>Prepare for the next development cycle</h1>

<p>XXX: adapt / fork for release candidates. In the meantime, read all
this, and skip what does not make sense for a RC.</p>

<ol>
<li>If you just released a new stable release, remove the previous
stable release from:

<ul>
<li>our rsync server:
<code>ssh rsync.lizard rm -rf /srv/rsync/tails/tails/stable/tails-amd64-${PREVIOUS_VERSION:?}/</code></li>
<li>our Bittorrent seed: get the previous release's <em>Transmission</em> ID
with <code>ssh bittorrent.lizard transmission-remote --list</code> and then
delete it with
<code>ssh bittorrent.lizard transmission-remote -t "${PREVIOUS_VERSION_TRANSMISSION_ID:?}" --remove-and-delete</code></li>
</ul>
</li>
<li>Remove any remaining RC for the just-published release from
the mirrors.</li>
<li><p>Remove IUKs that are more than 9 months old from
<code>/{stable,alpha}/iuk</code> on the rsync server:</p>

<ul>
<li><p>first check that it's not going to remove anything we want to keep:</p>

<pre><code>ssh rsync.lizard /bin/sh -c \
    \"find /srv/rsync/tails/tails/alpha  \
           /srv/rsync/tails/tails/stable \
           -type f -name '*.iuk' -mtime '+270' \
           -not -name '*~test_*~test.iuk' -ls \
    \"
</code></pre></li>
<li><p>then actually delete the files:</p>

<pre><code>ssh rsync.lizard /bin/sh -c \
    \"find /srv/rsync/tails/tails/alpha  \
           /srv/rsync/tails/tails/stable \
           -type f -name '*.iuk' -mtime '+270' \
           -not -name '*~test_*~test.iuk' -delete \
    \"
</code></pre></li>
</ul>
</li>
<li><p>Check how much space our mirrors need:</p>

<pre><code> ssh rsync.lizard du -sh /srv/rsync/tails
</code></pre>

<p>Compare it to the minimum disk space we ask of our mirror operators
(30 GiB) and determine if any further action is needed to either
reduce our usage by deleting stuff, or asking them to give us more
space.</p></li>
<li><p>Delete Git branches that were merged:</p>

<pre><code> cd "${MASTER_CHECKOUT:?}" &amp;&amp; \
 git checkout master &amp;&amp; \
 git fetch &amp;&amp; \
 git submodule update &amp;&amp; \
 bare_repo=$(mktemp -d)
 torsocks git clone --bare --reference "${MASTER_CHECKOUT:?}" \
    gitolite@d53ykjpeekuikgoq.onion:tails \
    "${bare_repo:?}" &amp;&amp; \
 PYTHONPATH=lib/python3 ./bin/delete-merged-git-branches \
    --repo "${bare_repo:?}" &amp;&amp; \
 rm -rf "${bare_repo:?}"
</code></pre></li>
<li><p>Remove all old versions in <code>wiki/src/upgrade/v1/Tails</code> and
<code>debian/changelog</code> that were never released. Explanation: the
post-release APT repository steps from the previous stable release
will usually have had us prepare for an emergency release that was
never made.</p></li>
<li><a href="./APT_repository/time-based_snapshots.html#freeze-exceptions-post-release">Thaw the packages that were granted freeze exceptions</a>.</li>
<li>Pull <code>master</code> back and merge it into <code>stable</code>, and in turn into
<code>devel</code></li>
<li><a href="./APT_repository/time-based_snapshots.html#thaw">Thaw</a>, on the devel
branch, the time-based APT repository snapshots that were used
during the freeze. This should generally be a no-op but if there
was some hiccup earlier it could be needed.</li>
<li>Follow the
<a href="./APT_repository/custom.html#workflow-post-release">post-release</a>
custom APT repository documentation. Make sure there are upgrade-description
files for any new versions that were added.</li>
<li><p>Verify that the snapshots used in the release branch are ok,
e.g. they use the correct snapshots, and they were bumped
appropriately (they should expire after the major release <em>after</em>
the one you're preparing). Look carefully at the output of this command:</p>

<pre><code> cd "${RELEASE_CHECKOUT:?}" &amp;&amp; \
 git checkout "${RELEASE_BRANCH:?}" &amp;&amp; \
 for dir in config/APT_snapshots.d vagrant/definitions/tails-builder/config/APT_snapshots.d; do
 (
     echo "${dir:?}:"
     cd "${dir:?}" &amp;&amp; \
     for ARCHIVE in * ; do
         SERIAL="$(cat ${ARCHIVE:?}/serial)"
         if [ "${SERIAL:?}" = 'latest' ]; then
             EXPIRY='never'
             if [ "${ARCHIVE:?}" != 'debian-security' ]; then
                 echo "Warning: origin '${ARCHIVE:?}' is using the 'latest' snapshot, which is unexpected" &gt;&amp;2
             fi
         else
             if [ "${ARCHIVE:?}" = 'debian-security' ]; then
                 DIST='stretch/updates'
             else
                 DIST='stable'
            fi
            EXPIRY="$(curl --silent "http://time-based.snapshots.deb.tails.boum.org/${ARCHIVE:?}/dists/${DIST:?}/snapshots/${SERIAL:?}/Release" | sed -n 's/^Valid-Until:\s\+\(.*\)$/\1/p')"
         fi
         echo "* Archive '${ARCHIVE:?}' uses snapshot '${SERIAL:?}' which expires on: ${EXPIRY:?}"
     done
     echo ---
 )
 done
</code></pre></li>
<li><p>Push the resulting branches.</p></li>
<li>Make sure Jenkins manages to build all updated major branches:
<a href="https://jenkins.tails.boum.org/">https://jenkins.tails.boum.org/</a>.</li>
<li>Make sure you pushed all changes in every of our Git repo (including our
Debian packages ones).</li>
<li>Delete the <em>Release Manager View for ${VERSION</em>:?}_ Redmine custom query.</li>
<li>Ensure the next two releases have their own <em>Release Manager View</em>.</li>
<li>On the <a href="https://tails.boum.org/contribute/roadmap">roadmap</a>, update the <em>Due date</em> for the <em>Holes
in the Roof</em> so that this section appears after the next release.</li>
<li>If you are the release manager for the next release too, look at the
tasks that must be done at the beginning of your shift in the
<a href="./working_together/roles/release_manager.html">release manager role page</a>.
Otherwise, kindly remind the next release manager about this :)</li>
</ol>


<h1><a name="index24h1"></a>Related pages</h1>

<div class="map">
<ul>
<li>
<a href="./release_process/Debian_security_updates.html" class="mapitem">Debian security updates</a>
</li>
<li>
<a href="./release_process/liveusb-creator.html" class="mapitem">liveusb-creator</a>
<ul>
<li>
<a href="./release_process/liveusb-creator/topic_branch.html" class="mapitem">topic branch</a>
</li>
</ul>
</li>
<li>
<a href="./release_process/perl5lib.html" class="mapitem">perl5lib</a>
</li>
<li>
<a href="./release_process/persistence-setup.html" class="mapitem">persistence-setup</a>
</li>
<li>
<a href="./release_process/tails-greeter.html" class="mapitem">tails-greeter</a>
</li>
<li>
<a href="./release_process/tails-installer.html" class="mapitem">tails-installer</a>
<ul>
<li>
<a href="./release_process/tails-installer/topic_branch.html" class="mapitem">topic branch</a>
</li>
</ul>
</li>
<li>
<a href="./release_process/tails-iuk.html" class="mapitem">tails-iuk</a>
</li>
<li>
<a href="./release_process/test.html" class="mapitem">test</a>
<ul>
<li>
<a href="./release_process/test/automated_tests.html" class="mapitem">automated tests</a>
</li>
<li>
<span class="createlink">reproducibility</span>
<ul>
<li>
<a href="./release_process/test/reproducibility/verification.html" class="mapitem">verification</a>
</li>
</ul>
</li>
<li>
<a href="./release_process/test/setup.html" class="mapitem">setup</a>
</li>
<li>
<a href="./release_process/test/test_results.html" class="mapitem">test results</a>
</li>
<li>
<a href="./release_process/test/usage.html" class="mapitem">usage</a>
</li>
</ul>
</li>
<li>
<a href="./release_process/thunderbird.html" class="mapitem">thunderbird</a>
</li>
<li>
<a href="./release_process/tor-browser.html" class="mapitem">tor-browser</a>
</li>
<li>
<a href="./release_process/tor-browser_AppArmor_patch.html" class="mapitem">tor-browser AppArmor patch</a>
</li>
</ul>
</div>




</div>







</div>

<div id="footer" class="pagefooter" role="contentinfo">

<div id="pageinfo">







<div id="backlinks">
Pages linking to this one:

<a href="./build/reproducible.html">build/reproducible</a>

<a href="../contribute.en.html">contribute</a>

<a href="../contribute.ar.html">contribute.ar</a>

<a href="../contribute.ca.html">contribute.ca</a>

<a href="../contribute.de.html">contribute.de</a>

<a href="../contribute.es.html">contribute.es</a>

<a href="../contribute.fa.html">contribute.fa</a>

<a href="../contribute.fr.html">contribute.fr</a>

<a href="../contribute.it.html">contribute.it</a>

<a href="../contribute.pl.html">contribute.pl</a>


<span class="popup">...
<span class="balloon">

<a href="../contribute.pt.html">contribute.pt</a>

<a href="../contribute.ru.html">contribute.ru</a>

<a href="../contribute.sr_Latn.html">contribute.sr Latn</a>

<a href="../contribute.tr.html">contribute.tr</a>

<a href="../contribute.zh.html">contribute.zh</a>

<a href="../contribute.zh_TW.html">contribute.zh TW</a>

<a href="./design/incremental_upgrades.html">design/incremental upgrades</a>

<a href="./design/reproducibility.html">design/reproducibility</a>

<a href="./git.html">git</a>

<a href="../news/report_2012_08.html">news/report 2012 08</a>

<a href="./release_process/test/reproducibility/verification.html">release process/test/reproducibility/verification</a>

<a href="./working_together/roles/release_manager.html">working together/roles/release manager</a>

<a href="./working_together/roles/sysadmins.html">working together/roles/sysadmins</a>

</span>
</span>

</div>






</div>
<div id="mirrorlist">Mirror: <a href="https://tails.boum.org/ikiwiki.cgi?do=goto&page=contribute/release_process">tails.boum.org</a></div>

<!-- from The Amnesic Incognito Live System -->
</div>

</div>

<script type="text/javascript">
  var linkelements = document.querySelectorAll('.use-mirror-pool');
  if(linkelements.length > 0) {
    replaceUrlPrefixWithRandomMirror(linkelements);
  }
</script>

</body>
</html>
