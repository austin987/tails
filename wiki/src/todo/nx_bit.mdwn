The [[!wikipedia NX_bit]] helps enabling executable space protection.
Most 64bits x86 CPUs support this but Tails ships a -686 32 bit
kernel.

[[!toc levels=2]]

It seems Debian's -686 kernel does dot enable this, but the
-686-bigmem kernel does: `CONFIG_X86_PAE=y` is set in the
`debian/config/i386/none/config.686-bigmem` file, inside Debian's
svn://svn.debian.org/svn/kernel/dists/sid/linux-2.6, since PAE require
HIGHMEM64 to be enabled in the kernel config.

To use a PAE + NX-enabled kernel we need to build an image with
`--linux-flavours 686-bigmem` in `auto/config`.

Beware! according to
[Wikipedia](https://secure.wikimedia.org/wikipedia/en/wiki/NX_bit#Linux)
"the PAE mode that is required to use the NX bit causes pre-Pentium
Pro (including Pentium MMX) and Celeron M and Pentium M processors
without NX support to fail to boot". This is confirmed by a great
number of sources:

- [report](http://www.kernelcrash.com/blog/openvz-and-asterisk-and-pae/2009/02/03/)
  of a thinkpad t42 not booting with PAE support enabled
- <https://answers.launchpad.net/ubuntu/+source/linux/+question/33381>
- <https://bugs.launchpad.net/ubuntu/+source/xen-source/+bug/111434>
- the first generation Pentium M (Banias) and some second generation
  Pentium M (Dothan) has no PAE support [will not boot if PAE is
  required](https://groups.google.com/a/chromium.org/group/chromium-os-dev/browse_thread/thread/f30ae8e73e451048)

=> seems like we cannot default to use the bigmem kernel, and should
at least provide the non-bigmem one as an alternative choice in the
bootloader or wait for non-PAE systems to be rare enough so that we
can stop supporting them.

> I guess the decision to ship a highmem kernel, and thus to enable to choose a
> kernel at boot time requires to finish the [[boot menu todo item|todo/boot_menu]]. OTOH,
> Pentium M machines are still widely spread, as a lot of refurbished latops
> are shipping it. Not sure what to decide here. First solution seems the best
> but requires some more work... --bertagaz

>> Update: Debian will stop shipping the -686 flavour as of 2.6.39
>> (reference: [Ben's
>> blog](http://womble.decadent.org.uk/blog/upcoming-changes-in-debian-linux-packages-for-i386.html)).
>> When we start shipping such kernels, either we'll ship -486 until
>> non-PAE systems die, or we'll ship both -686-pae and -486 *and*
>> we'll have the bootloader autodetect the most appropriate one
>> depending on what the kernel supports. See bellow for the current
>> state of our research.

# Implementation

The `feature/multikernel` branch:

- installs three kernels (`-486`, `-686-pae`, `-amd64`) => +90MB ISO
- offers two menu entries (*Start Tails* and *Start Tails (failsafe)*)
  that autoselect best kernel wrt. hardware support; other menu
  entries auto-generated by live-build are hidden, but behind the
  curtain the autodetection code jumps to the one it thinks is best

Next steps:

- avoid shipping every kernel twice (see
  [[todo/save_more_disk_space_at_build_time]])
- [[!taglink todo/wait]] for a graphical [[todo/boot_menu]] to take
  over the language choosing functionality.

# Resources

## Selecting the kernel depending on CPU

The `ifcpu64.c32`
[module](http://syslinux.zytor.com/wiki/index.php/Ifcpu64.c32) seems
to provide what we need, allowing to do different things for 64-bit
hardware, 32-bit hardware with PAE support and 32-bit hardware without
PAE, like this:

	label boot_kernel
		com32 ifcpu64.c32
		append boot_kernel_64 -- boot_kernel_32pae -- boot_kernel_32
	label boot_kernel_32
		kernel vmlinuz_32
		append ...
	label boot_kernel_32pae
		kernel vmlinuz_32pae
		append ...
	label boot_kernel_64
		kernel vmlinuz_64
		append ...

Unfortunately, it does not *select* a default kernel, but boots it
right away; we want to allow the user to customize the kernel command
line, so we have to add a (selected by default) menu entry that reads
something like *Autodetect and boot*.

### Discarded

#### HDT

The HDT (hardware detection tool) syslinux module
([homepage](http://www.hdt-project.org/), [page on syslinux
wiki](http://syslinux.zytor.com/wiki/index.php/Hdt_(Hardware_Detection_Tool)))
has code that might help supporting this; it's been shipped in
mainline syslinux for a while. On the other hand does *not* offer any
kind of feature that can be used to parameterized the boot menu.

#### default64 menu keyword

Debian multi-arch installer's syslinux menu autodetects
amd64-compatible hardware and pre-selects the right default kernel.
Seems like it uses the `default64` menu keyword (see debian-installer
Git repository). Unfortunately, this solution is not suitable for us
because it does not allow to select a kernel depending on PAE support,
and is [not part of recent syslinux
package](http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=505496#16).

#### ifcpu.c32

Other COM32 modules shipped with syslinux might be better suited for
our specific needs. See especially `ifcpu.c32`; according to its
source code, it can "run one command if system match some CPU
features, another if it doesn't" and is supposed to be used
e.g. like this:

	label ifcpu
	    com32 ifcpu.c32
	    append pae -- boot_entry_1 -- boot_entry_2

	label boot_entry_1
	    kernel vmlinuz_entry1
	    append ...

	label boot_entry_2
	    kernel vmlinuz_entry2
	    append ...

... which would almost suit our needs but only allows two
alternatives, while we need three.
