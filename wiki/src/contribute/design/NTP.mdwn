Versions
========

T(A)ILS 0.5 implements what this design document describes. We have
switched to using HTP in later versions: see our [[HTP design document|HTP]].

Rationale
=========

On the one hand, Tor sometimes freaks out if it detects a too large
clock skew. On the other hand, having the desktop environment display
localized time would be a nice bonus.

That’s why we want to fix the system clock, using some kind of suitable
network protocol, when a network interface is brought up and before
the Tor client is told it should connect to the network.

Implementation
==============

A naive NTP daemon installation does not work: it seems to hangup and
then timeout after two minutes, unnecessarily blocking xorg from
starting during that time. Even though ntp is allowed direct Internet
access, DNS resolution will still be performed through the Tor
network. Since we haven't got into xorg, networkmanager hasn't
connected and so our tor client cannot reach the Tor network.

Even if we could get Tor to bootstrap (and thus make DNS lookups
possible) before openntp starts, we'd have a problem if the clock is
too skewed that Tor cannot bootstrap (Tor requires a somewhat accurate
clock for security reasons) (Windows users in particular seem to get
incorrect clocks, perhaps since it stores the local time to the
hardware clock and the time is then intepreted as UTC in Linux).
That was the reason why NTP was added to Incognito in the first place.
It was made using `ntpdate` and OpenDNS with this
[script](https://tor-svn.freehaven.net/svn/incognito/trunk/root_overlay/etc/NetworkManager/dispatcher.d/50-ntp.sh).

... which works really well, but using OpenDNS to ever query
`pool.ntp.org` is too easy to fingerprint.

That’s why we rather use the DHCP-provided nameservers, when possible,
in `/etc/NetworkManager/dispatcher.d/50-ntp.sh`. Else, we still
use OpenDNS.

However, we really need `/etc/resolv.conf` to be setup in a way that
makes the rest of the system use the local (torified) DNS cache.
This is achieved thanks to the − properly configured −
`resolvconf` package.
