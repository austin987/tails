One serious security issue is that we don't know what software will
attempt to contact the network and whether their proxy settings are
setup to use the Tor SOCKS proxy or polipo HTTP(s) proxy correctly.
This is solved by forwarding all direct TCP connections through Tor's
transparent proxy using the Linux kernel level network filter.

- [[!tails_gitweb config/chroot_local-includes/etc/firewall.conf]] for IPv4
- [[!tails_gitweb config/chroot_local-includes/etc/firewall6.conf]] for IPv6
- [[!tails_gitweb config/chroot_local-includes/etc/NetworkManager/dispatcher.d/00-firewall.sh]]

The default case is to redirect traffic to the Tor transparent proxy;
let us now document the few exceptions to this rule.

#### Tor user

Tor itself obviously has to connect to the Internet without going
through the Tor network. This is achieved by special-casing
connections originating from the `debian-tor` Unix user.

#### HTP

T(A)ILS HTTP Time Protocol (HTP) setup is described on a [[dedicated
design page|design/HTP]].

Every HTP-related communication is established by the `htp` user, who
is allowed to connect *directly* to services listening on the `https`
TCP port or on the `domain` UDP/TCP ports.

The rationale for this exception is that we have kind of a
chicken'n'egg problem here. We want the clock to be pretty accurate in
order for Tor to work properly so HTP time synchronization has to be
done before Tor starts... hence *directly*. This means DNS queries to
resolve the HTP hosts IPs, and HTTPS traffic to fetch the pages and
associated resources.

An alternative implementation that would not need HTP to bypass Tor is
[[being thought of|todo/remove_the_htp_user_firewall_exception]].

#### I2P

**FIXME**: shortly tell about the rationale, expand the I2P abbrev.

The `i2p` user is allowed to connect *directly* to the Internet. See
[[the design document dedicated to our use of I2P|I2P]] for details.

#### Local Area Network (LAN)

T(A)ILS short description talks of sending through Tor *outgoing
connections to the Internet*. Indeed: traffic to the local LAN
(RFC1918 addresses) is wide open as well as the loopback traffic
obviously.

It is planned to [[forbid LAN DNS
queries|todo/forbid_lan_dns_queries]] at some point to protect against
some attacks; this is not implemented yet.

#### IPv6

Tor does not support IPv6 yet so IPv6 communication is allowed only on
the loopback interface.

#### UDP, ICMP and other non-TCP protocols

Tor only supports TCP. Non-TCP traffic to the Internet, such as UDP
datagrams and ICMP packets, is dropped.
