#!/bin/bash

# Refresh the included live user's $HOME directory by rsync'ing the
# specified one to config/chroot_local-includes/home/amnesia,
# excluding files matching the patterns found in the
# AMNESIA_HOME_EXCLUDES (see config/amnesia and doc/README for
# details).
#
# Usage: ./home-refresh [ SOURCE_DIR ]
#
#   SOURCE_DIR defaults to AMNESIA_REFRESH_HOME_SOURCE if not specified.


### source the configuration files

. config/amnesia
if [ -e config/amnesia.local ] ; then
   . config/amnesia.local
fi

### init variables

DEST_DIR="config/chroot_local-includes/home/amnesia"
if [ -z "$1" ]; then
   SOURCE_DIR="${AMNESIA_REFRESH_HOME_SOURCE}"
else
   SOURCE_DIR="$1"
fi

### helper functions

fatal () {
   echo "Fatal: $@" >&2
   exit 2
}

### sanity checks

[ -d "${DEST_DIR}" ] || fatal "the destination directory (${DEST_DIR}) does not exist."
[ -w "${DEST_DIR}" ] || fatal "the destination directory (${DEST_DIR}) is not writable."
[ -d "${SOURCE_DIR}" ] || fatal "the source directory (${SOURCE_DIR}) does not exist."
[ -r "${SOURCE_DIR}" ] || fatal "the source directory (${SOURCE_DIR}) is not readable."

# How to use $RSYNC_OPTS:
#    - $RSYNC_OPTS should be used unquoted
#    - 'set -o noglob' has to be run before any $RSYNC_OPTS use
#    - 'set +o noglob' has to be run after any $RSYNC_OPTS use
RSYNC_OPTS=""
set -o noglob
for pattern in $AMNESIA_HOME_EXCLUDES; do
    RSYNC_OPTS="$RSYNC_OPTS --exclude=$pattern"
done
set +o noglob

# Let's go!
set -o noglob
rsync \
   $RSYNC_OPTS \
   --recursive --links --perms --times --specials --one-file-system \
   --delete --delete-excluded \
   --verbose \
   --relative \
   "${SOURCE_DIR}/./" \
   "${DEST_DIR}/"
res=$?
set +o noglob

chmod 755 "${DEST_DIR}"

exit $res
