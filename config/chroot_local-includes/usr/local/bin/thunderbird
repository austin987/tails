#!/bin/sh

set -e
set -u
set -x

# Import set_mozilla_pref()
. /usr/local/lib/tails-shell-library/tor-browser.sh

# Import guess_best_thunderbird_locale():
. /usr/local/lib/tails-shell-library/thunderbird.sh

THUNDERBIRD_CONFIG_DIR="${HOME}/.thunderbird"
PROFILE="${THUNDERBIRD_CONFIG_DIR}/profile.default"

thunderbird_config_is_persistent() {
    [ "$(findmnt --noheadings --output SOURCE --target "${THUNDERBIRD_CONFIG_DIR}")" = "/dev/mapper/TailsData_unlocked[/thunderbird]" ]
}

configure_default_incoming_protocol() {
    # For extensions.torbirdy.defaultprotocol, POP = 0, IMAP = 1
    local default_protocol
    if thunderbird_config_is_persistent; then
        default_protocol=0
    else
        default_protocol=1
    fi
    mkdir -p "${PROFILE}"
    set_mozilla_pref "${PROFILE}/prefs.js"                 \
                     "extensions.torbirdy.defaultprotocol" \
                     "${default_protocol}"                 \
                     user_pref
}

configure_best_thunderbird_locale() {
    local locale
    locale=$(guess_best_thunderbird_locale)
    mkdir -p "${PROFILE}"
    set_mozilla_pref "${PROFILE}/prefs.js"   \
                     "intl.locale.requested" \
                     "\"${locale}\""         \
                     user_pref
}

start_thunderbird() {
    export GNOME_ACCESSIBILITY=1
    unset SESSION_MANAGER

    configure_default_incoming_protocol

    configure_best_thunderbird_locale

    exec /usr/bin/thunderbird --class "Thunderbird" -profile "${PROFILE}" "${@}"
}

start_thunderbird "${@}"
